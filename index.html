<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Quay video iOS/macOS</title>
<style>
  video { width: 100%; max-height: 50vh; background: #000; border-radius: 12px; }
  button { padding: 8px 12px; margin: 4px; }
  .rec-time { font-weight: bold; margin-top: 8px; }
</style>
</head>
<body>
<h2>üìπ Quay Video</h2>
<video id="preview" autoplay muted></video>
<div class="rec-time" id="recTime">00:00</div>
<div>
  <button id="btnStartRec">‚è∫Ô∏è B·∫Øt ƒë·∫ßu</button>
  <button id="btnStopRec" disabled>‚èπÔ∏è D·ª´ng</button>
  <button id="btnDownload" disabled>‚¨áÔ∏è L∆∞u video</button>
</div>

<script>
const preview = document.getElementById('preview');
const recTime = document.getElementById('recTime');
const btnStartRec = document.getElementById('btnStartRec');
const btnStopRec = document.getElementById('btnStopRec');
const btnDownload = document.getElementById('btnDownload');

let stream = null;
let recorder = null;
let chunks = [];
let timerInterval = null;
let seconds = 0;
let videoBlob = null;

// M·ªü camera
async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  preview.srcObject = stream;
}
startCamera();

// Format time
function formatTime(sec) {
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

// B·∫Øt ƒë·∫ßu quay
btnStartRec.onclick = () => {
  if (!stream) return;
  chunks = [];
  seconds = 0;
  recTime.textContent = "00:00";

  recorder = new MediaRecorder(stream, { mimeType: "video/webm;codecs=vp8,opus" });
  recorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
  recorder.onstop = () => {
    videoBlob = new Blob(chunks, { type: "video/webm" });
    btnDownload.disabled = false;
  };

  recorder.start();
  btnStartRec.disabled = true;
  btnStopRec.disabled = false;

  timerInterval = setInterval(() => {
    seconds++;
    recTime.textContent = formatTime(seconds);
  }, 1000);
};

// D·ª´ng quay
btnStopRec.onclick = () => {
  if (recorder && recorder.state === "recording") recorder.stop();
  clearInterval(timerInterval);
  recTime.textContent = formatTime(seconds);
  btnStartRec.disabled = false;
  btnStopRec.disabled = true;
};

// T·∫°o link download
btnDownload.onclick = () => {
  if (!videoBlob) return;
  const url = URL.createObjectURL(videoBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `video_${Date.now()}.webm`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
